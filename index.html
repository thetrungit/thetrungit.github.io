<!DOCTYPE html>
<html>
<head>
  <title>Báo Cáo Dịch Vụ Công</title>
</head>
<body>
  <h2>Báo Cáo Dịch Vụ Công</h2>
  <div id="user-count">Số người dùng: <span id="user-count-value">0</span></div>
  <form id="report-form">
    <!-- 8 dịch vụ -->
    <div id="services"></div>
    <button type="button" onclick="submitData()">Tạo Báo Cáo</button>
  </form>
  <div id="error-message" style="display:none; color:red;"></div>
  <div id="report"></div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwttVtyLwmsYUOqVUkQUncm4f1_BdwUB3t2Q-ieHmFMbD9Jw_sOWdUo5GayQ7Wd4jCC/exec';

    // Hiển thị số người dùng
    fetch(GOOGLE_SCRIPT_URL, {
      method: 'GET',
      mode: 'no-cors'
    })
    .then(response => response.text())
    .then(data => {
      const result = JSON.parse(data);
      document.getElementById('user-count-value').textContent = result.userCount;
    })
    .catch(error => console.error('Lỗi khi lấy số người dùng:', error));

    // Tạo form cho 8 dịch vụ
    const services = [
      "Đăng ký thương trú",
      "Đăng ký tam trú",
      "Khai báo tạm vắng",
      "Thông báo lưu trú",
      "Xác nhận số Chứng minh nhân dân khi đã được cấp thẻ Căn cước",
      "Cấp lại, đổi thẻ Căn cước",
      "Đăng ký biển số môtô, xe gắn máy",
      "Thu tiền nộp phạt xử lý vi phạm hành chính trong lĩnh vực giao thông, duyệt bỏ qua thuật bị ghi hình (Phạt nguội)"
    ];
    let html = '';
    for (let i = 1; i <= 8; i++) {
      html += `
        <div>
          <label>${i}. ${services[i-1]}</label><br>
          <input type="text" name="dichvu_${i}" value="${services[i-1]}"><br>
          <input type="checkbox" name="ketnoi_${i}"> Kết nối<br>
          <input type="number" name="tongso_${i}" placeholder="Tổng số"><br>
          <input type="number" name="tructuyen_${i}" placeholder="Trực tuyến"><br>
          <input type="number" name="dunghan_${i}" placeholder="Đúng hạn"><br>
          <input type="number" name="quahan_${i}" placeholder="Quá hạn"><br>
        </div>
      `;
    }
    document.getElementById('services').innerHTML = html;

    function submitData() {
      const button = document.querySelector('button');
      button.disabled = true;
      const dataArray = [];
      for (let i = 1; i <= 8; i++) {
        const dichvu = document.querySelector(`input[name="dichvu_${i}"]`).value;
        const ketnoi = document.querySelector(`input[name="ketnoi_${i}"]`).checked ? 'Đã kết nối' : 'Chưa kết nối';
        const tongso = parseInt(document.querySelector(`input[name="tongso_${i}"]`).value) || 0;
        const tructuyen = parseInt(document.querySelector(`input[name="tructuyen_${i}"]`).value) || 0;
        const tyle = 0; // Tự động tính ở server
        const dunghan = parseInt(document.querySelector(`input[name="dunghan_${i}"]`).value) || 0;
        const quahan = parseInt(document.querySelector(`input[name="quahan_${i}"]`).value) || 0;

        const data = {
          stt: i,
          dichvu: dichvu,
          ketnoi: ketnoi,
          tongso: tongso,
          tructuyen: tructuyen,
          tyle: tyle,
          dunghan: dunghan,
          quahan: quahan
        };
        dataArray.push(data);
      }
      console.log('Dữ liệu gửi đi:', JSON.stringify(dataArray));
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataArray),
        mode: 'no-cors'
      })
      .then(() => {
        alert('Dữ liệu đã được gửi! (Kiểm tra Google Sheets để xác nhận)');
        generateReport();
        fetch(GOOGLE_SCRIPT_URL, {
          method: 'GET',
          mode: 'no-cors'
        })
        .then(response => response.text())
        .then(data => {
          const result = JSON.parse(data);
          document.getElementById('user-count-value').textContent = result.userCount;
        });
        button.disabled = false;
      })
      .catch(error => {
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = 'Lỗi khi gửi dữ liệu: ' + error.message;
        errorMessage.style.display = 'block';
        button.disabled = false;
      });
    }

    function generateReport() {
      // Logic tạo báo cáo (giữ nguyên hoặc cập nhật nếu cần)
      document.getElementById('report').innerHTML = 'Báo cáo đã được tạo!';
    }
  </script>
</body>
</html>