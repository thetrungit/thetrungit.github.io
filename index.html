<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Báo Cáo Dịch Vụ Công</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    #report-form {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #2c3e50;
      color: #fff;
    }
    td {
      background-color: #fafafa;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      margin-right: 5px;
    }
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #34495e;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    #error-message {
      text-align: center;
      color: red;
      margin-top: 10px;
    }
    #report {
      max-width: 1200px;
      margin: 20px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    #report-table th {
      background-color: #27ae60;
    }
    @media (max-width: 768px) {
      table, th, td {
        display: block;
        width: 100%;
      }
      th {
        display: none;
      }
      td {
        padding: 10px;
        border: none;
        border-bottom: 1px solid #ddd;
        position: relative;
        padding-left: 50%;
      }
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        font-weight: bold;
        color: #333;
      }
    }
  </style>
</head>
<body>
  <h2>Báo Cáo Dịch Vụ Công</h2>
  <form id="report-form">
    <table>
      <thead>
        <tr>
          <th>STT</th>
          <th>Dịch Vụ</th>
          <th>Kết Nối</th>
          <th>Tổng Số</th>
          <th>Trực Tuyến</th>
          <th>Tỷ Lệ (%)</th>
          <th>Đúng Hạn</th>
          <th>Quá Hạn</th>
        </tr>
      </thead>
      <tbody id="services">
        <tr>
          <td data-label="STT"></td>
          <td data-label="Tên cán bộ" colspan="2"><input type="text" id="tenCanBo" name="tenCanBo" required placeholder="Nhập tên cán bộ"></td>
          <td data-label="Tên đơn vị" colspan="2"><input type="text" id="tenDonVi" name="tenDonVi" required placeholder="Nhập tên đơn vị"></td>
          <td data-label="" colspan="3"></td>
        </tr>
      </tbody>
    </table>
    <button type="button" onclick="addServiceRow()">Thêm Dịch Vụ</button>
    <button type="button" onclick="submitData()" id="submitBtn" disabled>Tạo Báo Cáo</button>
  </form>
  <div id="error-message" style="display:none;"></div>
  <div id="report">
    <h3>Báo Cáo Dữ Liệu</h3>
    <table id="report-table">
      <thead>
        <tr>
          <th>STT</th>
          <th>Dịch Vụ</th>
          <th>Kết Nối</th>
          <th>Tổng Số</th>
          <th>Trực Tuyến</th>
          <th>Tỷ Lệ (%)</th>
          <th>Đúng Hạn</th>
          <th>Quá Hạn</th>
        </tr>
      </thead>
      <tbody id="report-body"></tbody>
    </table>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4CNlAbFqi2aTHFHHVasgJCe6--IdAMXBPwPW7jpbWhwCFFQ2-rQXYBIsgI2W96tFg/exec';
    const MAX_SERVICES = 8;
    let serviceCount = 0;

    // Thêm hàng dịch vụ
    function addServiceRow() {
      if (serviceCount >= MAX_SERVICES - 1) { // -1 vì đã có dòng tên cán bộ và đơn vị
        alert("Đã đạt tối đa 8 dịch vụ!");
        return;
      }
      serviceCount++;
      const services = [
        "Đăng ký thương trú",
        "Đăng ký tam trú",
        "Khai báo tạm vắng",
        "Thông báo lưu trú",
        "Xác nhận số Chứng minh nhân dân khi đã được cấp thẻ Căn cước",
        "Cấp lại, đổi thẻ Căn cước",
        "Đăng ký biển số môtô, xe gắn máy",
        "Thu tiền nộp phạt xử lý vi phạm hành chính trong lĩnh vực giao thông, duyệt bỏ qua thuật bị ghi hình (Phạt nguội)"
      ];
      const tbody = document.getElementById('services');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="STT">${serviceCount + 1}</td>
        <td data-label="Dịch Vụ"><select name="dichvu_${serviceCount + 1}">
          ${services.map((service, index) => `<option value="${service}" ${index === serviceCount ? 'selected' : ''}>${service}</option>`).join('')}
        </select></td>
        <td data-label="Kết Nối"><input type="checkbox" name="ketnoi_${serviceCount + 1}" checked></td>
        <td data-label="Tổng Số"><input type="number" name="tongso_${serviceCount + 1}" placeholder="Tổng số" oninput="calculateTyLe(${serviceCount + 1})"></td>
        <td data-label="Trực Tuyến"><input type="number" name="tructuyen_${serviceCount + 1}" placeholder="Trực tuyến" oninput="calculateTyLe(${serviceCount + 1})"></td>
        <td data-label="Tỷ Lệ (%)"><span id="tyle_${serviceCount + 1}">0.00</span></td>
        <td data-label="Đúng Hạn"><input type="number" name="dunghan_${serviceCount + 1}" placeholder="Đúng hạn"></td>
        <td data-label="Quá Hạn"><input type="number" name="quahan_${serviceCount + 1}" placeholder="Quá hạn"></td>
      `;
      tbody.appendChild(row);
      checkFormValidity();
    }

    // Hàm tính tỷ lệ (%) trên client-side
    function calculateTyLe(index) {
      const tongso = parseInt(document.querySelector(`input[name="tongso_${index}"]`).value) || 0;
      const tructuyen = parseInt(document.querySelector(`input[name="tructuyen_${index}"]`).value) || 0;
      const tyle = tongso > 0 ? ((tructuyen / tongso) * 100).toFixed(2) : 0;
      document.getElementById(`tyle_${index}`).textContent = tyle;
      checkFormValidity();
    }

    // Kiểm tra tính hợp lệ của form
    function checkFormValidity() {
      const tenCanBo = document.getElementById('tenCanBo').value;
      const tenDonVi = document.getElementById('tenDonVi').value;
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = !(tenCanBo && tenDonVi);
    }

    // Gửi dữ liệu
    function submitData() {
      const button = document.getElementById('submitBtn');
      button.disabled = true;
      const dataArray = [];
      const tenCanBo = document.getElementById('tenCanBo').value;
      const tenDonVi = document.getElementById('tenDonVi').value;

      const rows = document.getElementById('services').getElementsByTagName('tr');
      for (let i = 1; i < rows.length; i++) { // Bỏ qua dòng đầu tiên (tên cán bộ và đơn vị)
        const stt = i;
        const dichvu = rows[i].querySelector(`select[name="dichvu_${stt}"]`).value;
        const ketnoi = rows[i].querySelector(`input[name="ketnoi_${stt}"]`).checked ? 'Đã kết nối' : 'Chưa kết nối';
        const tongso = parseInt(rows[i].querySelector(`input[name="tongso_${stt}"]`).value) || 0;
        const tructuyen = parseInt(rows[i].querySelector(`input[name="tructuyen_${stt}"]`).value) || 0;
        const tyle = parseFloat(document.getElementById(`tyle_${stt}`).textContent) || 0;
        const dunghan = parseInt(rows[i].querySelector(`input[name="dunghan_${stt}"]`).value) || 0;
        const quahan = parseInt(rows[i].querySelector(`input[name="quahan_${stt}"]`).value) || 0;

        const data = {
          stt: stt,
          tenCanBo: tenCanBo,
          tenDonVi: tenDonVi,
          dichvu: dichvu,
          ketnoi: ketnoi,
          tongso: tongso,
          tructuyen: tructuyen,
          tyle: tyle,
          dunghan: dunghan,
          quahan: quahan
        };
        dataArray.push(data);
      }

      console.log('Dữ liệu gửi đi:', JSON.stringify(dataArray));

      // Hiển thị báo cáo trên giao diện
      generateReport(dataArray);

      // Gửi dữ liệu lên Google Sheets
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataArray)
      })
      .then(response => response.text())
      .then(result => {
        if (result === "Success") {
          alert('Dữ liệu đã được gửi! (Kiểm tra Google Sheets để xác nhận)');
        } else {
          throw new Error(result);
        }
        button.disabled = false;
      })
      .catch(error => {
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = 'Lỗi khi gửi dữ liệu: ' + error.message;
        errorMessage.style.display = 'block';
        button.disabled = false;
      });
    }

    // Hiển thị báo cáo
    function generateReport(dataArray) {
      let html = '';
      dataArray.forEach(row => {
        html += `
          <tr>
            <td>${row.stt}</td>
            <td>${row.dichvu}</td>
            <td>${row.ketnoi}</td>
            <td>${row.tongso}</td>
            <td>${row.tructuyen}</td>
            <td>${row.tyle}</td>
            <td>${row.dunghan}</td>
            <td>${row.quahan}</td>
          </tr>
        `;
      });
      document.getElementById('report-body').innerHTML = html;
    }

    // Khởi tạo bảng với 1 hàng dịch vụ ban đầu
    initializeServices();
    function initializeServices() {
      addServiceRow();
    }

    // Gắn sự kiện onchange cho các input để kiểm tra hợp lệ
    document.getElementById('tenCanBo').addEventListener('input', checkFormValidity);
    document.getElementById('tenDonVi').addEventListener('input', checkFormValidity);
  </script>
</body>
</html>