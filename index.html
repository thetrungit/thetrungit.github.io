<!DOCTYPE html>
<html>
<head>
  <title>Báo Cáo Dịch Vụ Công</title>
</head>
<body>
  <h2>Báo Cáo Dịch Vụ Công</h2>
  <div id="user-count">Số người dùng: <span id="user-count-value">0</span></div>
  <form id="report-form">
    <!-- 8 dịch vụ -->
    <div id="services"></div>
    <button type="button" onclick="addService()">Thêm Dịch Vụ</button>
    <button type="button" onclick="submitData()">Tạo Báo Cáo</button>
  </form>
  <div id="error-message" style="display:none; color:red;"></div>
  <div id="report"></div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwttVtyLwmsYUOqVUkQUncm4f1_BdwUB3t2Q-ieHmFMbD9Jw_sOWdUo5GayQ7Wd4jCC/exec';
    let serviceCount = 8;

    document.addEventListener('DOMContentLoaded', async () => {
      await updateUserCount();
      initializeServicesForm();
    });

    async function updateUserCount() {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'GET', mode: 'no-cors' });
        const data = await response.text();
        const result = JSON.parse(data);
        document.getElementById('user-count-value').textContent = result.userCount;
      } catch (error) {
        console.error('Lỗi khi lấy số người dùng:', error);
      }
    }

    function initializeServicesForm() {
      const services = [
        "Đăng ký thương trú",
        "Đăng ký tạm trú",
        "Khai báo tạm vắng",
        "Thông báo lưu trú",
        "Xác nhận số Chứng minh nhân dân khi đã được cấp thẻ Căn cước",
        "Cấp lại, đổi thẻ Căn cước",
        "Đăng ký biển số môtô, xe gắn máy",
        "Thu tiền nộp phạt xử lý vi phạm hành chính trong lĩnh vực giao thông, duyệt bỏ qua lỗi bị ghi hình (Phạt nguội)"
      ];

      let html = '';
      for (let i = 1; i <= serviceCount; i++) {
        html += generateServiceRow(i, services[i-1]);
      }
      document.getElementById('services').innerHTML = html;
    }

    function generateServiceRow(index, serviceName = '') {
      return `
        <div class="service-row" data-index="${index}">
          <label>${index}. Dịch vụ</label><br>
          <input type="text" name="dichvu_${index}" value="${serviceName}"><br>
          <input type="checkbox" name="ketnoi_${index}"> Kết nối<br>
          <input type="number" name="tongso_${index}" placeholder="Tổng số"><br>
          <input type="number" name="tructuyen_${index}" placeholder="Trực tuyến"><br>
          <input type="number" name="dunghan_${index}" placeholder="Đúng hạn"><br>
          <input type="number" name="quahan_${index}" placeholder="Quá hạn"><br>
        </div>
      `;
    }

    function addService() {
      serviceCount++;
      const newServiceRow = generateServiceRow(serviceCount);
      document.getElementById('services').insertAdjacentHTML('beforeend', newServiceRow);
    }

    async function submitData() {
      const button = document.querySelector('button[onclick="submitData()"]');
      button.disabled = true;
      const dataArray = [];
      document.querySelectorAll('.service-row').forEach(row => {
        const index = row.getAttribute('data-index');
        const dichvu = document.querySelector(`input[name="dichvu_${index}"]`).value;
        const ketnoi = document.querySelector(`input[name="ketnoi_${index}"]`).checked ? 'Đã kết nối' : 'Chưa kết nối';
        const tongso = parseInt(document.querySelector(`input[name="tongso_${index}"]`).value) || 0;
        const tructuyen = parseInt(document.querySelector(`input[name="tructuyen_${index}"]`).value) || 0;
        const tyle = (tructuyen / tongso) * 100 || 0; // Tính tỷ lệ
        const dunghan = parseInt(document.querySelector(`input[name="dunghan_${index}"]`).value) || 0;
        const quahan = parseInt(document.querySelector(`input[name="quahan_${index}"]`).value) || 0;

        const data = {
          stt: index,
          dichvu: dichvu,
          ketnoi: ketnoi,
          tongso: tongso,
          tructuyen: tructuyen,
          tyle: tyle,
          dunghan: dunghan,
          quahan: quahan
        };
        dataArray.push(data);
      });

      try {
        console.log('Dữ liệu gửi đi:', JSON.stringify(dataArray));
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataArray),
          mode: 'no-cors'
        });
        alert('Dữ liệu đã được gửi! (Kiểm tra Google Sheets để xác nhận)');
        await updateUserCount();
        generateReport();
      } catch (error) {
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = 'Lỗi khi gửi dữ liệu: ' + error.message;
        errorMessage.style.display = 'block';
      } finally {
        button.disabled = false;
      }
    }

    function generateReport() {
      // Logic tạo báo cáo (giữ nguyên hoặc cập nhật nếu cần)
      document.getElementById('report').innerHTML = 'Báo cáo đã được tạo!';
    }
  </script>
</body>
</html>