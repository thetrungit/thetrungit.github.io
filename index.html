<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Báo Cáo Dịch Vụ Công</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    #user-count {
      text-align: center;
      font-size: 18px;
      color: #555;
      margin-bottom: 20px;
    }
    #user-count-value {
      font-weight: bold;
      color: #2c3e50;
    }
    #report-form {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #2c3e50;
      color: #fff;
    }
    td {
      background-color: #fafafa;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      margin-right: 5px;
    }
    button {
      display: block;
      width: 200px;
      margin: 20px auto;
      padding: 10px;
      background-color: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #34495e;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    #error-message {
      text-align: center;
      color: red;
      margin-top: 10px;
    }
    #report {
      max-width: 1200px;
      margin: 20px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    #report-table th {
      background-color: #27ae60;
    }
    @media (max-width: 768px) {
      table, th, td {
        display: block;
        width: 100%;
      }
      th {
        display: none;
      }
      td {
        padding: 10px;
        border: none;
        border-bottom: 1px solid #ddd;
        position: relative;
        padding-left: 50%;
      }
      td:before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: 45%;
        font-weight: bold;
        color: #333;
      }
    }
  </style>
</head>
<body>
  <h2>Báo Cáo Dịch Vụ Công</h2>
  <div id="user-count">Số người dùng: <span id="user-count-value">0</span></div>
  <form id="report-form">
    <table>
      <thead>
        <tr>
          <th>STT</th>
          <th>Dịch Vụ</th>
          <th>Kết Nối</th>
          <th>Tổng Số</th>
          <th>Trực Tuyến</th>
          <th>Tỷ Lệ (%)</th>
          <th>Đúng Hạn</th>
          <th>Quá Hạn</th>
        </tr>
      </thead>
      <tbody id="services"></tbody>
    </table>
    <button type="button" onclick="submitData()">Tạo Báo Cáo</button>
  </form>
  <div id="error-message" style="display:none;"></div>
  <div id="report">
    <h3>Báo Cáo Dữ Liệu</h3>
    <table id="report-table">
      <thead>
        <tr>
          <th>STT</th>
          <th>Dịch Vụ</th>
          <th>Kết Nối</th>
          <th>Tổng Số</th>
          <th>Trực Tuyến</th>
          <th>Tỷ Lệ (%)</th>
          <th>Đúng Hạn</th>
          <th>Quá Hạn</th>
        </tr>
      </thead>
      <tbody id="report-body"></tbody>
    </table>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwttVtyLwmsYUOqVUkQUncm4f1_BdwUB3t2Q-ieHmFMbD9Jw_sOWdUo5GayQ7Wd4jCC/exec';

    // Lấy số người dùng khi tải trang
    fetch(GOOGLE_SCRIPT_URL, {
      method: 'GET',
      mode: 'no-cors'
    })
    .then(response => response.text())
    .then(data => {
      try {
        const result = JSON.parse(data);
        document.getElementById('user-count-value').textContent = result.userCount;
      } catch (e) {
        console.error('Lỗi parse JSON:', e);
      }
    })
    .catch(error => console.error('Lỗi khi lấy số người dùng:', error));

    // Tạo bảng cho 8 dịch vụ
    const services = [
      "Đăng ký thương trú",
      "Đăng ký tam trú",
      "Khai báo tạm vắng",
      "Thông báo lưu trú",
      "Xác nhận số Chứng minh nhân dân khi đã được cấp thẻ Căn cước",
      "Cấp lại, đổi thẻ Căn cước",
      "Đăng ký biển số môtô, xe gắn máy",
      "Thu tiền nộp phạt xử lý vi phạm hành chính trong lĩnh vực giao thông, duyệt bỏ qua thuật bị ghi hình (Phạt nguội)"
    ];
    let html = '';
    for (let i = 1; i <= 8; i++) {
      html += `
        <tr>
          <td data-label="STT">${i}</td>
          <td data-label="Dịch Vụ"><input type="text" name="dichvu_${i}" value="${services[i-1]}" readonly></td>
          <td data-label="Kết Nối"><input type="checkbox" name="ketnoi_${i}" checked></td>
          <td data-label="Tổng Số"><input type="number" name="tongso_${i}" placeholder="Tổng số" oninput="calculateTyLe(${i})"></td>
          <td data-label="Trực Tuyến"><input type="number" name="tructuyen_${i}" placeholder="Trực tuyến" oninput="calculateTyLe(${i})"></td>
          <td data-label="Tỷ Lệ (%)"><span id="tyle_${i}">0.00</span></td>
          <td data-label="Đúng Hạn"><input type="number" name="dunghan_${i}" placeholder="Đúng hạn"></td>
          <td data-label="Quá Hạn"><input type="number" name="quahan_${i}" placeholder="Quá hạn"></td>
        </tr>
      `;
    }
    document.getElementById('services').innerHTML = html;

    // Hàm tính tỷ lệ (%) trên client-side
    function calculateTyLe(index) {
      const tongso = parseInt(document.querySelector(`input[name="tongso_${index}"]`).value) || 0;
      const tructuyen = parseInt(document.querySelector(`input[name="tructuyen_${index}"]`).value) || 0;
      const tyle = tongso > 0 ? ((tructuyen / tongso) * 100).toFixed(2) : 0;
      document.getElementById(`tyle_${index}`).textContent = tyle;
    }

    function submitData() {
      const button = document.querySelector('button');
      button.disabled = true;
      const dataArray = [];
      for (let i = 1; i <= 8; i++) {
        const dichvu = document.querySelector(`input[name="dichvu_${i}"]`).value;
        const ketnoi = document.querySelector(`input[name="ketnoi_${i}"]`).checked ? 'Đã kết nối' : 'Chưa kết nối';
        const tongso = parseInt(document.querySelector(`input[name="tongso_${i}"]`).value) || 0;
        const tructuyen = parseInt(document.querySelector(`input[name="tructuyen_${i}"]`).value) || 0;
        const tyle = parseFloat(document.getElementById(`tyle_${i}`).textContent) || 0;
        const dunghan = parseInt(document.querySelector(`input[name="dunghan_${i}"]`).value) || 0;
        const quahan = parseInt(document.querySelector(`input[name="quahan_${i}"]`).value) || 0;

        const data = {
          stt: i,
          dichvu: dichvu,
          ketnoi: ketnoi,
          tongso: tongso,
          tructuyen: tructuyen,
          tyle: tyle,
          dunghan: dunghan,
          quahan: quahan
        };
        dataArray.push(data);
      }
      console.log('Dữ liệu gửi đi:', JSON.stringify(dataArray));

      // Hiển thị báo cáo trên giao diện
      generateReport(dataArray);

      // Gửi dữ liệu lên Google Sheets
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataArray),
        mode: 'no-cors'
      })
      .then(() => {
        alert('Dữ liệu đã được gửi! (Kiểm tra Google Sheets để xác nhận)');
        fetch(GOOGLE_SCRIPT_URL, {
          method: 'GET',
          mode: 'no-cors'
        })
        .then(response => response.text())
        .then(data => {
          try {
            const result = JSON.parse(data);
            document.getElementById('user-count-value').textContent = result.userCount;
          } catch (e) {
            console.error('Lỗi parse JSON:', e);
          }
        });
        button.disabled = false;
      })
      .catch(error => {
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = 'Lỗi khi gửi dữ liệu: ' + error.message;
        errorMessage.style.display = 'block';
        button.disabled = false;
      });
    }

    function generateReport(dataArray) {
      let html = '';
      dataArray.forEach(row => {
        html += `
          <tr>
            <td>${row.stt}</td>
            <td>${row.dichvu}</td>
            <td>${row.ketnoi}</td>
            <td>${row.tongso}</td>
            <td>${row.tructuyen}</td>
            <td>${row.tyle}</td>
            <td>${row.dunghan}</td>
            <td>${row.quahan}</td>
          </tr>
        `;
      });
      document.getElementById('report-body').innerHTML = html;
    }
  </script>
</body>
</html>